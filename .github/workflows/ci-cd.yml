name: Deploy FastAPI to AWS EC2 with Docker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Deploy to EC2
        env:
          HOST: ec2-13-229-215-11.ap-southeast-1.compute.amazonaws.com
          KEY: ${{ secrets.EC2_KEY }}
          USER: ubuntu
        run: |
          echo "$KEY" > citykey.pem
          chmod 400 citykey.pem

          ssh -o StrictHostKeyChecking=no -i citykey.pem $USER@$HOST << 'EOF'
            set -e  # Stop on any error

            echo "ðŸ” Switching to project directory..."
            cd /home/ubuntu/travelapi || {
              echo "ðŸ“‚ Cloning repo since folder does not exist..."
              git clone https://github.com/ashifbabu/travelapi.git /home/ubuntu/travelapi
              cd /home/ubuntu/travelapi
            }

            echo "ðŸ”„ Resetting to latest main branch..."
            git fetch --all
            git reset --hard origin/main

            echo "ðŸ›‘ Stopping existing Docker containers (if any)..."
            docker-compose down || true

            echo "ðŸ³ Rebuilding and starting Docker containers..."
            docker-compose up -d --build

            echo "âœ… Deployment complete."
          EOF
